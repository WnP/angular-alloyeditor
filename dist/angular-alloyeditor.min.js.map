{"version":3,"sources":["angular-alloyeditor.js"],"names":["global","factory","define","amd","angular","this","alloyEditorDirective","$parse","$timeout","compile","tElement","tAttrs","id","Error","post","postLink","pre","preLink","$scope","$element","$attributes","$controllers","initialize","forEach","event","alloyEditorCtrl","onEvent","ngModelCtrl","$setViewValue","nativeEditor","getData","$watch","readonly","readonlyWatch","$setTouched","onready","newValue","oldValue","setReadOnly","Boolean","syncEditor","ready","then","setData","$viewValue","callback","fire","noSnapshot","$render","editorElement","find","editorID","attr","config","createInstance","directive","controller","controllerAs","require","restrict","template","AlloyEditorController","$q","$log","readyDeferred","promise","instance","get","elementId","AlloyEditor","editable","resolve","listener","asyncListener","args","arguments","applyListener","apply","$apply","on","removeListener","vm","defer","$on","destroy","e","debug","module","$inject"],"mappings":"CAAA,SAAUA,EAAQC,GAChB,YACsB,mBAAXC,SAAyBA,OAAOC,IAAKD,QAAQ,WAAYD,GAC/DA,EAAQG,UACZC,KAAM,SAASD,GAChB,YASA,SAASE,GAAqBC,EAAQC,GAYpC,QAASC,GAAQC,EAAUC,GACzB,IAAKA,EAAOC,GACV,KAAMC,OAAM,mDAEd,QACEC,KAAMC,EACNC,IAAKC,GAIT,QAASF,GAASG,EAAQC,EAAUC,EAAaC,GAU/C,QAASC,MAEN,SAAU,QAAQC,QAAQ,SAAuBC,GAChDC,EAAgBC,QAAQF,EAAO,WAC7BG,EAAYC,cAAcH,EAAgBI,eAAeC,WAAa,QAI1EZ,EAAOa,OAAOX,EAAYY,SAAUC,GAEpCR,EAAgBC,QAAQ,QAAS,WAC/BC,EAAYO,gBAKd1B,EAAS,WACPD,EAAOa,EAAYe,SAASjB,KAIhC,QAASe,GAAcG,EAAUC,GAC3BD,IAAaC,GACfZ,EAAgBI,eAAeS,YAAYC,QAAQH,IAIvD,QAASI,KACPf,EAAgBgB,QAAQC,KAAK,WAC3BjB,EAAgBI,eAAec,QAAQhB,EAAYiB,YAAc,IAC/DC,SAAU,WAIRpB,EAAgBI,eAAeiB,KAAK,mBAEtCC,YAAY,MA7ClB,GAAItB,GAAkBJ,EAAa,GAC/BM,EAAcN,EAAa,EAG/BI,GAAgBgB,QAAQC,KAAKpB,GAG7BK,EAAYqB,QAAUR,EA4CxB,QAASvB,GAAQC,EAAQC,EAAUC,EAAaC,GAC9C,GAAII,GAAkBJ,EAAa,GAC/B4B,EAAgB9B,EAAS+B,KAAK,OAC9BC,EAAW/B,EAAYR,GAAK,UAChCqC,GAAcG,KAAK,KAAMD,EACzB,IAAIE,GAAS9C,EAAOa,EAAYiC,QAAQnC,EACxCO,GAAgB6B,eAAeH,EAAUE,GA/E3C,GAAIE,IACF9C,QAASA,EACT+C,WAAY,wBACZC,aAAc,kBACdC,SAAU,cAAe,WACzBC,SAAU,IACVC,SAAU,mCAGZ,OAAOL,GA4ET,QAASM,GAAsBC,EAAI5C,EAAQV,EAAUuD,GA6BnD,QAAStB,KACP,MAAOuB,GAAcC,QAGvB,QAASpC,KACP,MAAOqC,GAASC,IAAI,gBAWtB,QAASb,GAAec,EAAWf,GAMjC,MALAa,GAAWG,YAAYC,SAASF,EAAWf,GAC3C3B,EAAQ,gBAAiB,WACvBsC,EAAcO,SAAQ,KAGjBL,EAYT,QAASxC,GAAQF,EAAOgD,GAGtB,QAASC,KACP,GAAIC,GAAOC,SACXnE,GAAS,WACPoE,EAAcC,MAAM,KAAMH,KAI9B,QAASE,KACP,GAAIF,GAAOC,SACXzD,GAAO4D,OAAO,WACZN,EAASK,MAAM,KAAMH,KAKzB,MAjBA7C,KAAekD,GAAGvD,EAAOiD,GAiBlB,WACL5C,IAAemD,eAAexD,EAAOoD,IAjFzC,GAEIV,GAFAe,EAAK5E,KACL2D,EAAgBF,EAAGoB,OAGvBD,GAAG3B,eAAiBA,EACpB2B,EAAGvD,QAAUA,EACbuD,EAAGxC,MAAQA,EACXwC,EAAGpD,aAAeA,EAGlBX,EAAOiE,IAAI,WAAY,WAErBnB,EAAcC,QAAQvB,KAAK,WACzB,IAAMwB,EAASkB,UACf,MAAOC,GAAKtB,EAAKuB,MAAM,2BAA4BD,QAIvDnE,EAAOiE,IAAI,sBAAuB,WAEhCnB,EAAcC,QAAQvB,KAAK,WACzB,IAAMwB,EAASkB,UACf,MAAOC,GACLtB,EAAKuB,MAAM,6CAA8CD,QArHjEjF,EACGmF,OAAO,kBACP/B,WAAW,wBAAyBK,GACpCN,UAAU,cAAejD,GAE5BA,EAAqBkF,SAAW,SAAU,YAsF1C3B,EAAsB2B,SAAW,KAAM,SAAU,WAAY","file":"angular-alloyeditor.min.js","sourcesContent":["(function(global, factory) {\n  'use strict';\n  if (typeof define === 'function' && define.amd) define(['angular'], factory);\n  else factory(angular);\n})(this, function(angular) {\n  'use strict';\n\n  angular\n    .module('alloyeditor', [])\n    .controller('AlloyEditorController', AlloyEditorController)\n    .directive('alloyEditor', alloyEditorDirective);\n\n  alloyEditorDirective.$inject = ['$parse', '$timeout'];\n\n  function alloyEditorDirective($parse, $timeout) {\n    var directive = {\n      compile: compile,\n      controller: 'AlloyEditorController',\n      controllerAs: 'alloyEditorCtrl',\n      require: ['alloyEditor', 'ngModel'],\n      restrict: 'E',\n      template: '<div class=\"alloy-editor\"></div>'\n    };\n\n    return directive;\n\n    function compile(tElement, tAttrs) {\n      if (!tAttrs.id) {\n        throw Error('The alloy-editor element must have id attribute.');\n      }\n      return {\n        post: postLink,\n        pre: preLink\n      };\n    }\n\n    function postLink($scope, $element, $attributes, $controllers) {\n      var alloyEditorCtrl = $controllers[0];\n      var ngModelCtrl = $controllers[1];\n\n      // Initialize the editor content when it is ready.\n      alloyEditorCtrl.ready().then(initialize);\n\n      // Set editor data when view data change.\n      ngModelCtrl.$render = syncEditor;\n\n      function initialize() {\n        // Sync view on specific events.\n        ['change', 'blur'].forEach(function syncViewEvent(event) {\n          alloyEditorCtrl.onEvent(event, function syncView() {\n            ngModelCtrl.$setViewValue(alloyEditorCtrl.nativeEditor().getData() || '');\n          });\n        });\n\n        $scope.$watch($attributes.readonly, readonlyWatch);\n\n        alloyEditorCtrl.onEvent('focus', function syncTouched() {\n          ngModelCtrl.$setTouched();\n        });\n\n        // Defer the ready handler calling to ensure that the editor is\n        // completely ready and populated with data.\n        $timeout(function() {\n          $parse($attributes.onready)($scope);\n        });\n      }\n\n      function readonlyWatch(newValue, oldValue) {\n        if (newValue !== oldValue) {\n          alloyEditorCtrl.nativeEditor().setReadOnly(Boolean(newValue));\n        }\n      }\n\n      function syncEditor() {\n        alloyEditorCtrl.ready().then(function() {\n          alloyEditorCtrl.nativeEditor().setData(ngModelCtrl.$viewValue || '', {\n            callback: function() {\n              // Amends the top of the undo stack with the current DOM changes\n              // ie: merge snapshot with the first empty one\n              // http://docs.ckeditor.com/#!/api/CKEDITOR.editor-event-updateSnapshot\n              alloyEditorCtrl.nativeEditor().fire('updateSnapshot');\n            },\n            noSnapshot: true\n          });\n        });\n      }\n    }\n\n    function preLink($scope, $element, $attributes, $controllers) {\n      var alloyEditorCtrl = $controllers[0];\n      var editorElement = $element.find('div');\n      var editorID = $attributes.id + '-content';\n      editorElement.attr('id', editorID);\n      var config = $parse($attributes.config)($scope);\n      alloyEditorCtrl.createInstance(editorID, config);\n    }\n  }\n\n  AlloyEditorController.$inject = ['$q', '$scope', '$timeout', '$log'];\n\n  function AlloyEditorController($q, $scope, $timeout, $log) {\n    var vm = this;\n    var readyDeferred = $q.defer();\n    var instance;\n\n    vm.createInstance = createInstance;\n    vm.onEvent = onEvent;\n    vm.ready = ready;\n    vm.nativeEditor = nativeEditor;\n\n    // Destroy editor when the scope is destroyed.\n    $scope.$on('$destroy', function onDestroy() {\n      // do not delete too fast or pending events will throw errors\n      readyDeferred.promise.then(function() {\n        try { instance.destroy(); }\n        catch (e) { $log.debug('Cannot destroy instance:', e) }\n      });\n    });\n\n    $scope.$on('destroy-alloyeditor', function onDestroy() {\n      // do not delete too fast or pending events will throw errors\n      readyDeferred.promise.then(function() {\n        try { instance.destroy(); }\n        catch (e) {\n          $log.debug('Cannot destroy instance from custom event:', e)\n        }\n      });\n    });\n\n    function ready() {\n      return readyDeferred.promise;\n    }\n\n    function nativeEditor() {\n      return instance.get('nativeEditor');\n    }\n\n    /**\n     * Invoke create method on AlloyEditor passing the ID of the node you want to edit.\n     *\n     * @param {String} elementId Id of the node you want to edit.\n     * @param {Object} config Configuration of this instance by AlloyEditor.\n     *\n     * @returns {Object} Instance of AlloyEditor.\n     */\n    function createInstance(elementId, config) {\n      instance = AlloyEditor.editable(elementId, config);\n      onEvent('instanceReady', function() {\n        readyDeferred.resolve(true);\n      });\n\n      return instance;\n    }\n\n    /**\n     * Listen on events of a given type.\n     * This make all event asynchronous and wrapped in $scope.$apply.\n     *\n     * @param {String} event Type-name of event listener.\n     * @param {Function} listener Exevute this function on listener.\n     *\n     * @returns {Function} Deregistration function for this listener.\n     */\n    function onEvent(event, listener) {\n      nativeEditor().on(event, asyncListener);\n\n      function asyncListener() {\n        var args = arguments;\n        $timeout(function() {\n          applyListener.apply(null, args);\n        });\n      }\n\n      function applyListener() {\n        var args = arguments;\n        $scope.$apply(function() {\n          listener.apply(null, args);\n        });\n      }\n\n      // Return the deregistration function\n      return function $off() {\n        nativeEditor().removeListener(event, applyListener);\n      };\n    }\n  }\n});\n"]}